<!--  ant build file for running hadoop -->
<project name="hadoop pre-reqs" default="hadoop_run">

	<property name="jar.dir" location="./tmp_jars" />
	
	<property name="libs.bsf" location="../libs.bsf" />
    <property name="batch" location="../repast.simphony.batch" />
    <property name="core" location="../repast.simphony.core" />
    <property name="runtime" location="../repast.simphony.runtime" />	
    <property name="data" location="../repast.simphony.data" />	
    <property name="data.loader" location="../repast.simphony.dataLoader" />	
    <property name="scenario" location="../repast.simphony.scenario" />
    <property name="essentials" location="../repast.simphony.essentials" />
    <property name="groovy" location="../repast.simphony.groovy" />
    <property name="integration" location="../repast.simphony.integration" />
    <property name="relogo.runtime" location="../repast.simphony.relogo.runtime" />
    <property name="relogo.ide" location="../repast.simphony.relogo.ide" />
    
    
	
	<property name="hadoop.bin" location="./bin" />
	<property name="hadoop.bin.lib" location="${hadoop.bin}/lib" />

	<property name="model.dir" location="./test_data/JZombies" />
	<property name="model.dir.bin" location="${model.dir}/bin" />
	<property name="model.dir.lib" location="${model.dir}/lib" />
	<property name="model.scenario" location="${model.dir}/JZombies.rs" />
	<property name="model.scenario.zip" value="scenario.zip" />
	
	

	<!-- Make jars and copy them to bin/lib. The contents of that directory become part of
		the mappers classpath -->
	<target name="make_pre_reqs">
		<mkdir dir="${hadoop.bin.lib}" />

        <!--  jar up the bin directories for the required projects -->
		<jar destfile="${hadoop.bin.lib}/repast.simphony.batch.jar" basedir="${batch}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.core.jar" basedir="${core}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.runtime.jar" basedir="${runtime}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.data.jar" basedir="${data}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.dataLoader.jar" basedir="${data.loader}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.scenario.jar" basedir="${scenario}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.essentials.jar" basedir="${essentials}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.groovy.jar" basedir="${groovy}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.integration.jar" basedir="${integration}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.relogo.runtime.jar" basedir="${relogo.runtime}/bin" />
		<jar destfile="${hadoop.bin.lib}/repast.simphony.relogo.ide.jar" basedir="${relogo.ide}/bin" />
		

        <!-- copy project's 3rd party libs to the hadoop lib directory -->
		<copy todir="${hadoop.bin.lib}">
		      <fileset dir="${libs.bsf}/lib">
		          <include name="*.jar"/>
		      </fileset>
		
			<fileset dir="${core}/lib">
				<include name="collections-generic-4.01.jar" />
				<include name="jscience.jar" />
				<include name="glib-nodep-2.1_3.jar" />
				<include name="colt-1.2.0-no_hep.jar" />
				<include name="concurrent-1.3.4.jar" />
				<include name="jbullet.jar" />
				<include name="jgap.jar" />
				<include name="jgap.jar" />
			</fileset>

			<fileset dir="${runtime}/lib">
				<include name="saf.core.runtime.jar" />
			</fileset>

			<fileset dir="${model.dir.lib}">
				<include name="*.jar" />
			</fileset>
		</copy>

        <jar destfile="${hadoop.bin.lib}/model.jar" basedir="${model.dir.bin}" />
        
		<zip destfile="${jar.dir}/${model.scenario.zip}" basedir="${model.scenario}"/>
			
		<jar destfile="${jar.dir}/repast.simphony.hadoop.jar" basedir="${hadoop.bin}" />
	</target>

	<target name="hadoop_delete_output" depends="make_pre_reqs">
		<exec dir="." executable="/usr/local/hadoop-1.0.1/bin/hadoop">
			<arg value="fs" />
			<arg value="-rmr" />
			<arg value="output" />
		</exec>
	</target>

	<target name="hadoop_run" depends="hadoop_delete_output">
		<exec dir="." executable="/usr/local/hadoop-1.0.1/bin/hadoop">
			<arg value="jar" />
			<arg value="${jar.dir}/repast.simphony.hadoop.jar" />
			<arg value="repast.simphony.engine.BatchJob" />
			<arg value="-files" />
			<arg value="test_data/batch_params.xml" />
			<arg value="-archives" />
			<arg value="${jar.dir}/scenario.zip" />
			<!--
			<arg value="-libjars" />
			<arg value="tmp_jars/repast.simphony.core.jar,tmp_jars/collections-generic-4.01.jar,tmp_jars/saf.core.runtime.jar,tmp_jars/jscience.jar" />
			-->
			<arg value="hadoop_input.txt" />
			<arg value="./output" />
		</exec>
	</target>

</project>